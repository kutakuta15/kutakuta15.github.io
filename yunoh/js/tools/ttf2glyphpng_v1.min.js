let gridSize=16,canvasSize=1024,cellSize=canvasSize/gridSize,toHex2=n=>n.toString(16).padStart(2,"0").toUpperCase();async function createFontFace(name,data){name=new FontFace(name,data);await name.load(),document.fonts.add(name)}function isHalfWidth(char){return char.match(/[\x20-\x7E]/)}function createSimpleZip(files){var file,encoder=new TextEncoder,fileEntries=[],fileData=[];let offset=0;function crc32(buf){var table=crc32.table||(crc32.table=Array.from({length:256},(_,n)=>{let c=n;for(let k=0;k<8;k++)c=1&c?3988292384^c>>>1:c>>>1;return c>>>0}));let crc=4294967295;for(let i=0;i<buf.length;i++)crc=table[255&(crc^buf[i])]^crc>>>8;return(4294967295^crc)>>>0}function toLE(n,bytes){var out=[];for(let i=0;i<bytes;i++)out.push(n>>8*i&255);return out}for(file of files){var{name,data}=file,name=encoder.encode(name),crc=crc32(data),localHeader=[80,75,3,4,20,0,0,0,0,0,0,0,0,0,...toLE(crc,4),...toLE(data.length,4),...toLE(data.length,4),...toLE(name.length,2),0,0];fileData.push(new Uint8Array(localHeader)),fileData.push(name),fileData.push(new Uint8Array(data)),fileEntries.push({nameBytes:name,offset:offset,size:data.length,crc:crc}),offset+=localHeader.length+name.length+data.length}var centralDir=[];let centralDirSize=0;for(let file of fileEntries){let{nameBytes,offset:relOffset,size,crc}=file;var header=[80,75,1,2,20,0,20,0,0,0,0,0,0,0,0,0,...toLE(crc,4),...toLE(size,4),...toLE(size,4),...toLE(nameBytes.length,2),0,0,0,0,0,0,0,0,0,0,0,0,...toLE(relOffset,4)];centralDir.push(new Uint8Array(header)),centralDir.push(nameBytes),centralDirSize+=header.length+nameBytes.length}files=[80,75,5,6,0,0,0,0,...toLE(fileEntries.length,2),...toLE(fileEntries.length,2),...toLE(centralDirSize,4),...toLE(offset,4),0,0];return new Blob([...fileData,...centralDir,new Uint8Array(files)],{type:"application/zip"})}document.getElementById("generate").onclick=async()=>{var file,useFonts=[];for(file of document.getElementById("fontFile").files){var buffer=await file.arrayBuffer(),name=file.name.replace(/\W/g,"_");await createFontFace(name,buffer),useFonts.push(name)}var fontCSS=[...useFonts,"consola_ttf","sans-serif"].join(", "),progress=document.getElementById("progress"),status=document.getElementById("status");progress.value=0,status.textContent="開始中...";let canvas=document.createElement("canvas");canvas.width=canvasSize,canvas.height=canvasSize;var ctx=canvas.getContext("2d"),pngFiles=(ctx.textBaseline="alphabetic",ctx.textAlign="left",ctx.font=.8*cellSize+"px "+fontCSS,ctx.fillStyle="#FFF",[]);for(let high=0;high<=255;high++){ctx.clearRect(0,0,canvasSize,canvasSize),ctx.textBaseline="middle";for(let low=0;low<=255;low++){var codePoint=high<<8|low,codePoint=String.fromCharCode(codePoint),x=(isHalfWidth(codePoint)?ctx.textAlign="left":ctx.textAlign="center",low%gridSize*cellSize+(isHalfWidth(codePoint)?0:cellSize/2)),y=Math.floor(low/gridSize)*cellSize+cellSize/2;ctx.fillText(codePoint,x,y)}var arrayBuffer=await(await new Promise(res=>canvas.toBlob(res,"image/png"))).arrayBuffer();pngFiles.push({name:`Glyph_${toHex2(high)}.png`,data:new Uint8Array(arrayBuffer)}),progress.value=high+1,status.textContent=`作成中: Glyph_${toHex2(high)}.png (${high+1}/256)`,await new Promise(r=>setTimeout(r,0))}status.textContent="ZIP作成中...";var fontCSS=createSimpleZip(pngFiles),fontCSS=URL.createObjectURL(fontCSS),a=document.createElement("a");a.href=fontCSS,a.download="glyphs.zip",a.click(),status.textContent="完了！"};